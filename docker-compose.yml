version: '3.8'

services:
  cockroachdb:
    container_name: cockroachdb
    image: cockroachdb/cockroach:latest
    command: start-single-node --insecure --store=path=/var/lib/cockroach
    restart: always
    ports:
      - "26257:26257"
      - "8080:8080"
    volumes:
      - cockroach-data:/var/lib/cockroach

  nakama:
    container_name: nakama
    image: heroiclabs/nakama:3.22.0
    depends_on:
      - cockroachdb
    entrypoint:
      - "/bin/sh"
      - "-ecx"
      - |
        echo "Waiting for CockroachDB..."
        until nc -z cockroachdb 26257; do
          sleep 2
        done
        echo "Running Nakama migrations..."
        /nakama/nakama migrate up --database.address root@cockroachdb:26257
        echo "Starting Nakama server..."
        exec /nakama/nakama --name nakama1 --config /nakama/data/local.yml --database.address root@cockroachdb:26257
    ports:
      - "7349:7349"
      - "7350:7350"
      - "7351:7351"
    volumes:
      - nakama-data:/nakama/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7350/"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  cockroach-data:
  nakama-data:
